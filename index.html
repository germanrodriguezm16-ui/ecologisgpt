<script>
  function $(s, el){ return (el||document).querySelector(s); }
  function $all(s, el){ return Array.prototype.slice.call((el||document).querySelectorAll(s)); }
  function debug(msg){ var d=$('#debug'); if(d) d.textContent=String(msg); }
  function esc(s){ return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }
  function fmt(n){ return Number(n||0).toLocaleString('es-CO',{maximumFractionDigits:2}); }

  var SUPABASE_URL      = (window.APP_CONFIG && window.APP_CONFIG.SUPABASE_URL)      || "";
  var SUPABASE_ANON_KEY = (window.APP_CONFIG && window.APP_CONFIG.SUPABASE_ANON_KEY) || "";
  if (!/^https?:\/\//.test(SUPABASE_URL) || !SUPABASE_ANON_KEY) {
    debug('⚠️ Configura SUPABASE_URL / ANON KEY en config.js');
  }

  /* Navegación básica y vistas */
  var titleEl = $('#title'), viewEl = $('#view'), navEl = $('#nav'), topActions = $('#topActions');
  var currentCat=null, currentCatName='';
  var prefView = localStorage.getItem('sociosViewMode') || 'cards'; // 'cards' | 'list'
  var catEditId = null; // ← clave para saber si estamos editando categoría
  var socioEditId = null;

  var VIEWS = {
    pedidos: function(){ return demoCard('Pedidos'); },
    seguimiento: function(){ return demoCard('Seguimiento'); },
    clientes: function(){ return demoCard('Clientes'); },
    inventario: function(){ return demoCard('Inventario'); },
    devoluciones: function(){ return demoCard('Devoluciones'); },
    transacciones: function(){ return demoCard('Transacciones'); },
    socios: function(){
      var root = document.createElement('div');
      root.id='sociosRoot';
      root.appendChild(el('div',{id:'socTop',class:'actions-inline',style:{marginBottom:'12px'}}));
      root.appendChild(el('div',{id:'socGrid',class:'grid'}));
      return root;
    }
  };

  function demoCard(t){ var c=document.createElement('div'); c.className='card'; c.innerHTML='<h3>'+t+'</h3><p class="muted">Vista demo.</p>'; return c; }
  function el(tag, attrs, children){
    var node=document.createElement(tag), k; attrs=attrs||{};
    for(k in attrs){
      if(k==='class') node.className=attrs[k];
      else if(k==='style'){ for(var s in attrs[k]) node.style[s]=attrs[k][s]; }
      else node.setAttribute(k, attrs[k]);
    }
    (children||[]).forEach(function(c){
      if(c==null) return;
      if(typeof c==='string') node.appendChild(document.createTextNode(c));
      else node.appendChild(c);
    });
    return node;
  }

  function setActive(tab){
    $all('.nav-btn', navEl).forEach(function(b){ b.classList.toggle('active', b.dataset.view===tab); });
    titleEl.textContent = tab.charAt(0).toUpperCase()+tab.slice(1);
    viewEl.innerHTML = '';
    var viewFactory=VIEWS[tab];
    if(typeof viewFactory==='function') viewEl.appendChild(viewFactory());
    else viewEl.appendChild(demoCard('Sin contenido'));
    location.hash = tab;
    if(tab==='socios') initSociosView();
    else topActions.innerHTML='';
  }

  navEl.addEventListener('click', function(e){
    var btn = e.target.closest('.nav-btn'); if(!btn) return;
    setActive(btn.dataset.view);
  });

  setActive((location.hash||'#socios').slice(1));

  /* Supabase JS */
  var supabaseClient=null;
  (function addSupabase(){
    var s=document.createElement('script');
    s.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js";
    s.onload=function(){
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      if((location.hash||'#socios').slice(1)==='socios') loadCategorias();
    };
    document.head.appendChild(s);
  })();

  /* Utilidades contraste */
  function hexToRgb(hex){ hex=String(hex||'').replace('#',''); if(hex.length===3) hex=hex.split('').map(function(x){return x+x;}).join(''); var num=parseInt(hex,16); if(isNaN(num)) return {r:0,g:0,b:0}; return {r:(num>>16)&255,g:(num>>8)&255,b:num&255};}
  function relLum(c){ function ch(v){v/=255; return v<=0.03928? v/12.92 : Math.pow((v+0.055)/1.055,2.4);} return 0.2126*ch(c.r)+0.7152*ch(c.g)+0.0722*ch(c.b);}
  function contrastColor(bg){ var L=relLum(hexToRgb(bg)); return L>0.5?'#000':'#fff'; }
  function mutedFor(bg){ return contrastColor(bg)==='#000'?'rgba(0,0,0,.72)':'rgba(255,255,255,.72)'; }
  function borderOn(bg){ var L=relLum(hexToRgb(bg)); return L>0.5?'rgba(0,0,0,.25)':'rgba(255,255,255,.25)'; }

  /* ====== CATEGORÍAS ====== */
  function initSociosView(){
    topActions.innerHTML = '<button class="btn primary" id="btnNuevaCat" type="button">Crear categoría de socios</button>';
    $('#btnNuevaCat').addEventListener('click', function(){ openCatModal('create'); });
    loadCategorias();
  }

  function openCatModal(mode, row){
    catEditId = (mode==='edit' && row && row.id) ? row.id : null;
    $('#modalTitle').textContent = catEditId? 'Editar categoría' : 'Nueva categoría';
    var f = $('#formCat');
    f.nombre.value = row?.nombre || '';
    f.color.value  = row?.color  || '#3ba55d';
    f.balance.value = row?.balance ?? 0;
    $('#modalCat').style.display='flex';
  }

  $('#btnCancelCat').addEventListener('click', function(){ $('#modalCat').style.display='none'; catEditId=null; });

  $('#formCat').addEventListener('submit', async function(e){
    e.preventDefault();
    var f=e.target;
    var nombre=f.nombre.value.trim(), color=f.color.value||'#3ba55d', balance=parseFloat(f.balance.value||'0');
    if(!nombre) return alert('Nombre obligatorio');

    if (catEditId){
      var {error} = await supabaseClient.from('categorias_socios').update({nombre,color,balance}).eq('id', catEditId);
      if(error) return alert(error.message);
    } else {
      var ins = await supabaseClient.from('categorias_socios').insert([{nombre,color,balance}]);
      if(ins.error) return alert(ins.error.message);
    }
    $('#modalCat').style.display='none';
    catEditId = null;
    loadCategorias();
  });

  function buildCatCard(row){
    var bg=row.color||'#3ba55d', txt=contrastColor(bg), muted=mutedFor(bg), brd=borderOn(bg);
    var card=el('div',{class:'card',style:{background:bg,borderColor:brd,color:txt}},[]);
    card.setAttribute('data-id',String(row.id||''));
    var top=el('div',{class:'row'},[]), left=el('div',null,[]), actions=el('div',{class:'actions'},[]);
    var title=el('div',{style:{display:'flex',alignItems:'center',gap:'8px',fontWeight:'700'}},[]);
    title.appendChild(el('span',{class:'color-dot',style:{background:bg}}));
    title.appendChild(el('span',null,[String(row.nombre||'—')]));
    var bal=el('div',{style:{marginTop:'6px',color:muted}},['Balance: $'+fmt(row.balance||0)]);
    left.appendChild(title); left.appendChild(bal);

    var ebtn=el('button',{class:'icon-btn edit',title:'Editar',type:'button'},[]); ebtn.innerHTML=pencil();
    var dbtn=el('button',{class:'icon-btn delete',title:'Eliminar',type:'button'},[]); dbtn.innerHTML=trash();
    // Listeners para acciones
    ebtn.addEventListener('click', function(ev){ ev.stopPropagation(); openCatModal('edit', row); });
    dbtn.addEventListener('click', function(ev){ ev.stopPropagation(); deleteCategoria(row.id); });

    actions.appendChild(ebtn); actions.appendChild(dbtn);
    top.appendChild(left); top.appendChild(actions); card.appendChild(top);

    // Click card: abrir socios de esa categoría
    card.addEventListener('click', function(ev){
      if(ev.target.closest('.icon-btn')) return;
      openSociosList(row.id, row.nombre);
    });

    return card;
  }

  async function deleteCategoria(id){
    if(!confirm('¿Eliminar esta categoría?')) return;
    var {error} = await supabaseClient.from('categorias_socios').delete().eq('id', id);
    if(error) return alert(error.message);
    loadCategorias();
  }

  async function loadCategorias(){
    var grid=$('#socGrid'); grid.innerHTML='<div class="loading">Cargando categorías…</div>';
    var {data,error} = await supabaseClient
      .from('categorias_socios')
      .select('*')
      .order('orden',{ascending:true,nullsFirst:true})
      .order('created_at',{ascending:false});
    if(error){ grid.innerHTML='<div class="error">'+esc(error.message)+'</div>'; return; }

    grid.innerHTML='';
    (data||[]).forEach(function(r){ grid.appendChild(buildCatCard(r)); });

    // Habilitar drag & drop para reordenar categorías
    if (window.Sortable && (data||[]).length){
      Sortable.create(grid, {
        animation:150,
        ghostClass:'drag-ghost',
        onEnd: async function(){
          try{
            var items = $all('.card', grid).map(function(card, idx){
              return { id: Number(card.getAttribute('data-id')), orden: idx+1 };
            });
            // Guardar orden en Supabase
            await Promise.all(items.map(function(it){
              return supabaseClient.from('categorias_socios').update({orden: it.orden}).eq('id', it.id);
            }));
          }catch(err){ console.error(err); alert('No se pudo guardar el nuevo orden de categorías.'); }
        }
      });
    }
  }

  function pencil(){return '<svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" stroke="currentColor" stroke-width="1.5"/></svg>';}
  function trash(){return '<svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M6 7h12M9 7V4h6v3m-8 3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>';}

  /* ====== SUBVISTA: SOCIOS POR CATEGORÍA ====== */
  function openSociosList(catId, catName){
    currentCat=catId; currentCatName=catName||'Socios';
    titleEl.textContent = 'Socios · '+currentCatName;
    viewEl.innerHTML='';
    // top actions
    var labelBtn = (currentCatName.toLowerCase()==='proveedores' ? 'Crear proveedor' : 'Crear socio');
    topActions.innerHTML = ''
      + '<button class="btn ghost" id="btnBack" type="button">← Volver</button>'
      + '<div class="actions-inline">'
      + ' <button class="btn '+(prefView==='list'?'warn':'')+'" id="btnList" type="button">Lista</button>'
      + ' <button class="btn '+(prefView==='cards'?'warn':'')+'" id="btnCards" type="button">Tarjetas</button>'
      + ' <button class="btn primary" id="btnNewSocio" type="button">'+esc(labelBtn)+'</button>'
      + '</div>';

    $('#btnBack').addEventListener('click', function(){ setActive('socios'); });
    $('#btnList').addEventListener('click', function(){ prefView='list'; localStorage.setItem('sociosViewMode','list'); renderSocios(); this.classList.add('warn'); $('#btnCards').classList.remove('warn'); });
    $('#btnCards').addEventListener('click', function(){ prefView='cards'; localStorage.setItem('sociosViewMode','cards'); renderSocios(); this.classList.add('warn'); $('#btnList').classList.remove('warn'); });
    $('#btnNewSocio').addEventListener('click', function(){ openSocioModal(); });

    viewEl.appendChild(el('div',{id:'socContent'},['Cargando…']));
    renderSocios();
  }

  async function fetchSocios(){
    var q = supabaseClient.from('socios').select('*').eq('categoria_id', currentCat)
      .order('orden',{ascending:true,nullsFirst:true})
      .order('created_at',{ascending:false});
    var {data,error} = await q;
    if(error){ return {rows:[], error:error}; }
    return {rows:data||[], error:null};
  }

  async function renderSocios(){
    var cont = $('#socContent'); cont.innerHTML='Cargando…';
    var r = await fetchSocios();
    if(r.error){ cont.innerHTML='<div class="error">'+esc(r.error.message)+'</div>'; return; }
    var rows = r.rows;
    if(!rows.length){ cont.innerHTML='<div class="empty">No hay socios en esta categoría.</div>'; return; }

    if(prefView==='list'){ cont.innerHTML=''; cont.appendChild(buildSociosTable(rows)); }
    else { cont.innerHTML=''; cont.appendChild(buildSociosCards(rows)); }

    // Drag & drop para socios (solo en tarjetas)
    if (prefView==='cards' && window.Sortable){
      var grid = $('#socContent .grid');
      if (grid){
        Sortable.create(grid, {
          animation:150,
          onEnd: async function(){
            try{
              var items = $all('.card', grid).map(function(card, idx){
                return { id: Number(card.getAttribute('data-id')), orden: idx+1 };
              });
              await Promise.all(items.map(function(it){
                return supabaseClient.from('socios').update({orden: it.orden}).eq('id', it.id);
              }));
            }catch(err){ console.error(err); alert('No se pudo guardar el nuevo orden de socios.'); }
          }
        });
      }
    }
  }

  function initials(txt){
    txt=String(txt||''); var p=txt.trim().split(/\s+/); var ini=p.slice(0,2).map(function(x){return x[0]||'';}).join('').toUpperCase();
    return ini||'SO';
  }

  function buildSociosTable(rows){
    var table = document.createElement('table'); table.className='list';
    var thead=document.createElement('thead'); var trh=document.createElement('tr');
    ['','Empresa','Titular','Teléfono','Dirección',''].forEach(function(h){ var th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
    thead.appendChild(trh); table.appendChild(thead);

    var tbody=document.createElement('tbody');
    rows.forEach(function(r){
      var tr=document.createElement('tr'); tr.setAttribute('data-id', r.id);

      var td0=document.createElement('td');
      var img=r.avatar_url?('<img class="avatar" src="'+esc(r.avatar_url)+'" alt="">') : ('<div class="avatar" style="display:grid;place-items:center;color:var(--muted);font-weight:700">'+initials(r.empresa)+'</div>');
      td0.innerHTML=img; tr.appendChild(td0);

      var td1=document.createElement('td'); td1.innerHTML='<div class="row-flex"><span>'+esc(r.empresa)+'</span></div>'; tr.appendChild(td1);
      var td2=document.createElement('td'); td2.textContent=r.titular||'—'; tr.appendChild(td2);
      var td3=document.createElement('td'); td3.textContent=r.telefono||'—'; tr.appendChild(td3);
      var td4=document.createElement('td'); td4.textContent=r.direccion||'—'; tr.appendChild(td4);

      var td5=document.createElement('td'); td5.innerHTML=''
        + '<div class="mini-actions">'
        + '<button class="icon-btn edit" type="button" data-edit="'+r.id+'">'+pencil()+'</button>'
        + '<button class="icon-btn delete" type="button" data-del="'+r.id+'">'+trash()+'</button>'
        + '</div>';
      tr.appendChild(td5);

      tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    // bind actions
    $all('[data-edit]', table).forEach(function(b){ b.addEventListener('click', function(){ openSocioModal(rows.find(function(x){return String(x.id)===String(b.getAttribute('data-edit'));})); }); });
    $all('[data-del]', table).forEach(function(b){ b.addEventListener('click', function(){ deleteSocio(b.getAttribute('data-del')); }); });

    return table;
  }

  function buildSociosCards(rows){
    var grid = document.createElement('div'); grid.className='grid';
    rows.forEach(function(r){
      var c=document.createElement('div'); c.className='card'; c.setAttribute('data-id', r.id);
      // color de tarjeta de socio
      var col = r.card_color || 'var(--card)';
      c.style.background = col;
      c.style.borderColor = borderOn(col);
      c.style.color = contrastColor(col);

      var header=document.createElement('div'); header.className='row';
      var left=document.createElement('div'); left.className='row-flex';
      var avatar;
      if(r.avatar_url){ avatar=document.createElement('img'); avatar.className='avatar'; avatar.src=r.avatar_url; }
      else { avatar=document.createElement('div'); avatar.className='avatar'; avatar.style.display='grid'; avatar.style.placeItems='center'; avatar.style.color='var(--muted)'; avatar.style.fontWeight='700'; avatar.textContent=initials(r.empresa); }
      left.appendChild(avatar);
      var titleWrap=document.createElement('div');
      var h=document.createElement('div'); h.style.fontWeight='700'; h.textContent=r.empresa||'—';
      var sub=document.createElement('div'); sub.className='muted'; sub.textContent=r.titular||'—';
      titleWrap.appendChild(h); titleWrap.appendChild(sub);
      left.appendChild(titleWrap);
      var actions=document.createElement('div'); actions.className='actions';
      var ebtn=document.createElement('button'); ebtn.className='icon-btn edit'; ebtn.innerHTML=pencil(); ebtn.setAttribute('data-edit',r.id); ebtn.type='button';
      var dbtn=document.createElement('button'); dbtn.className='icon-btn delete'; dbtn.innerHTML=trash(); dbtn.setAttribute('data-del',r.id); dbtn.type='button';
      actions.appendChild(ebtn); actions.appendChild(dbtn);
      header.appendChild(left); header.appendChild(actions);
      c.appendChild(header);

      var meta=document.createElement('div'); meta.className='muted'; meta.style.marginTop='8px';
      meta.textContent=(r.telefono||'—') + (r.direccion?(' · '+r.direccion):'');
      c.appendChild(meta);

      grid.appendChild(c);
    });

    // bind actions
    $all('[data-edit]', grid).forEach(function(b){ b.addEventListener('click', function(e){ e.stopPropagation(); openSocioModal(rows.find(function(x){return String(x.id)===String(b.getAttribute('data-edit'));})); }); });
    $all('[data-del]', grid).forEach(function(b){ b.addEventListener('click', function(e){ e.stopPropagation(); deleteSocio(b.getAttribute('data-del')); }); });

    return grid;
  }

  /* ====== Modal socio con subida de imagen ====== */
  var socioModal = $('#modalSocio'), socioForm = $('#formSocio');
  $('#btnCancelSocio').addEventListener('click', function(){ socioModal.style.display='none'; socioEditId=null; });

  function openSocioModal(socio){
    socioEditId = socio && socio.id ? socio.id : null;
    $('#modalSocioTitle').textContent = socioEditId ? 'Editar socio' : (currentCatName.toLowerCase()==='proveedores'?'Editar proveedor':'Nuevo socio').replace('Editar','Nuevo');
    socioForm.empresa.value = (socio && socio.empresa) || '';
    socioForm.titular.value = (socio && socio.titular) || '';
    socioForm.telefono.value = (socio && socio.telefono) || '';
    socioForm.direccion.value = (socio && socio.direccion) || '';
    // limpiar input de archivo
    socioForm.avatar.value = '';
    socioModal.style.display='flex';
  }

  socioForm.addEventListener('submit', async function(e){
    e.preventDefault();
    if(!supabaseClient) return alert('Cliente Supabase no disponible');
    var empresa=socioForm.empresa.value.trim();
    var titular=socioForm.titular.value.trim();
    if(!empresa || !titular) return alert('Empresa y Titular son obligatorios');
    var telefono=socioForm.telefono.value.trim();
    var direccion=socioForm.direccion.value.trim();

    let newId = socioEditId;
    if(socioEditId){
      var up = await supabaseClient.from('socios').update({empresa,titular,telefono,direccion}).eq('id', socioEditId);
      if(up.error) return alert(up.error.message);
    } else {
      var ins = await supabaseClient.from('socios').insert([{categoria_id: currentCat, empresa, titular, telefono, direccion}]).select('id').single();
      if(ins.error) return alert(ins.error.message);
      newId = ins.data.id;
    }

    // subir imagen si adjunta
    var file = socioForm.avatar.files[0];
    if(file){
      if(file.size > 2*1024*1024) return alert('El archivo supera 2 MB');
      var path = newId + '/' + Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9._-]/g,'_');
      var upImg = await supabaseClient.storage.from('socios').upload(path, file, {upsert:true});
      if(upImg.error){ alert('Error subiendo imagen: '+upImg.error.message); }
      else {
        var pub = supabaseClient.storage.from('socios').getPublicUrl(path);
        var url = pub && pub.data && pub.data.publicUrl;
        if(url){ await supabaseClient.from('socios').update({avatar_url:url}).eq('id', newId); }
      }
    }

    socioModal.style.display='none'; socioEditId=null;
    renderSocios();
  });

  async function deleteSocio(id){
    if(!confirm('¿Eliminar este socio?')) return;
    var {error} = await supabaseClient.from('socios').delete().eq('id', id);
    if(error) return alert(error.message);
    renderSocios();
  }
</script>
