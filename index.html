<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ecologist-GPT ¬∑ Panel</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --card:#121a26; --text:#e6edf3;
      --muted:#9fb0c2; --primary:#3ba55d; --border:#223044; --danger:#d9534f;
      --blue:#1e76ff; --red:#e4504d; --yellow:#ffda55;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:var(--bg); color:var(--text)}
    .layout{display:grid; grid-template-columns:260px 1fr; min-height:100dvh}
    aside{background:var(--panel); border-right:1px solid var(--border); padding:16px; position:sticky; top:0; height:100dvh}
    .brand{display:flex; gap:10px; align-items:center; margin-bottom:18px}
    .logo{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,#2b8a3e,var(--primary)); display:grid; place-items:center; font-weight:700}
    .brand h1{font-size:16px; margin:0}
    .muted{color:var(--muted); font-size:12px}
    nav{display:flex; flex-direction:column; gap:6px; margin-top:12px}
    .nav-btn{appearance:none; border:1px solid var(--border); background:transparent; color:var(--text);
      text-align:left; padding:10px 12px; border-radius:10px; cursor:pointer; font-size:14px}
    .nav-btn.active{background:var(--card); border-color:#2a3a52}
    main{padding:24px}
    .topbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; gap:12px; flex-wrap:wrap}
    .title{font-size:18px; font-weight:700}
    .actions-inline{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid var(--border); background:var(--card); color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer}
    .btn.primary{background:var(--primary); border-color:#2b8a3e; color:#0a140d; font-weight:700}
    .btn.ghost{background:transparent}
    .btn.warn{background:var(--yellow); color:#1a1a1a; border-color:#c6a700}
    .grid{display:grid; gap:12px; grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      will-change: transform, box-shadow;
    }
    .card:hover{ transform: translateY(-4px); box-shadow: 0 10px 24px rgba(0,0,0,.25); }
    .row{display:flex; justify-content:space-between; gap:8px; align-items:flex-start}
    .color-dot{width:12px; height:12px; border-radius:999px; display:inline-block; margin-right:6px; border:1px solid #0005}
    .actions{display:flex; gap:8px}
    .icon-btn{
      background:transparent; border:1px solid var(--border); border-radius:10px;
      width:34px; height:34px; display:grid; place-items:center; cursor:pointer; transition:filter .15s ease,opacity .15s ease
    }
    .icon{width:18px; height:18px; display:block}
    .icon-btn.edit{ background:var(--blue); border-color:#1357c2; color:#fff }
    .icon-btn.delete{ background:var(--red);  border-color:#b23a37; color:#fff }

    .empty, .error, .loading{color:var(--muted); padding:16px}
    .debug{position:fixed; right:12px; top:12px; background:#09111a; border:1px solid var(--border); padding:8px 10px; border-radius:10px; font-size:12px; color:var(--muted); z-index:99}
    input[type="text"], input[type="number"], input[type="email"], input[type="tel"], input[type="color"]{
      background:var(--card); border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:10px; width:100%
    }
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}

    /* Modal */
    .backdrop{position:fixed; inset:0; background:rgb(0 0 0 / .5); display:none; align-items:center; justify-content:center; padding:16px; z-index:50}
    .modal{background:var(--card); border:1px solid var(--border); border-radius:16px; max-width:640px; width:100%; padding:16px}
    .modal h3{margin:0 0 12px 0}
    .modal .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .modal .footer{display:flex; justify-content:flex-end; gap:10px; margin-top:12px}
    @media (max-width:900px){ .layout{grid-template-columns:1fr} aside{position:static; height:auto} .modal .grid2{grid-template-columns:1fr} }
    a{color:inherit; text-decoration:none}

    /* Socios list view */
    .list{width:100%; border-collapse:collapse; background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden}
    .list thead th{font-size:12px; text-align:left; color:var(--muted); background:#0f1823; padding:10px 12px; border-bottom:1px solid var(--border)}
    .list tbody td{padding:12px; border-bottom:1px solid var(--border)}
    .mini-actions{display:flex; gap:6px}
    .avatar{width:36px; height:36px; border-radius:999px; object-fit:cover; background:#0e1520; border:1px solid var(--border)}
    .row-flex{display:flex; align-items:center; gap:10px}
    .tag{font-size:11px; color:#0b1a0f; background:var(--primary); border:1px solid #2b8a3e; padding:2px 7px; border-radius:999px}
  </style>

  <script src="config.js"></script>
  <script src="https://browser.sentry-cdn.com/8.20.0/bundle.tracing.min.js" crossorigin="anonymous"></script>
  <script>
    (function(){
      var DSN = (window.APP_CONFIG && window.APP_CONFIG.SENTRY_DSN) || "";
      if (DSN && window.Sentry) { Sentry.init({ dsn: DSN, environment: "production", tracesSampleRate: 0 }); }
    })();
  </script>
</head>
<body>
  <div class="debug" id="debug">listo</div>

  <div class="layout">
    <aside>
      <div class="brand">
        <div class="logo">EG</div>
        <div>
          <h1>Ecologist-GPT</h1>
          <div class="muted">Panel principal</div>
        </div>
      </div>
      <nav id="nav">
        <button class="nav-btn" data-view="pedidos">üßæ Pedidos</button>
        <button class="nav-btn" data-view="seguimiento">üìç Seguimiento</button>
        <button class="nav-btn" data-view="clientes">üë• Clientes</button>
        <button class="nav-btn" data-view="inventario">üì¶ Inventario</button>
        <button class="nav-btn" data-view="devoluciones">‚Ü©Ô∏è Devoluciones</button>
        <button class="nav-btn" data-view="transacciones">üí≥ Transacciones</button>
        <button class="nav-btn" data-view="socios">ü§ù Socios</button>
      </nav>
      <div class="muted" style="margin-top:10px">v0.9 ¬∑ socios por categor√≠a</div>
    </aside>

    <main>
      <div class="topbar">
        <div class="title" id="title">‚Äî</div>
        <div id="topActions" class="actions-inline"></div>
      </div>
      <div id="view"></div>
    </main>
  </div>

  <!-- Modal Categor√≠a -->
  <div class="backdrop" id="modalCat">
    <div class="modal">
      <h3 id="modalTitle">Nueva categor√≠a</h3>
      <form id="formCat">
        <div class="grid2">
          <div>
            <label>Nombre</label>
            <input name="nombre" type="text" placeholder="Ej: Proveedores" required />
          </div>
          <div>
            <label>Color</label>
            <input name="color" type="color" value="#3ba55d" />
          </div>
        </div>
        <div style="margin-top:12px">
          <label>Balance (placeholder)</label>
          <input name="balance" type="number" step="0.01" value="0" />
          <div class="muted" style="margin-top:6px">Luego ser√° calculado autom√°ticamente.</div>
        </div>
        <div class="modal footer">
          <button type="button" class="btn" id="btnCancelCat">Cancelar</button>
          <button type="submit" class="btn primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Socio (crear/editar) -->
  <div class="backdrop" id="modalSocio">
    <div class="modal">
      <h3 id="modalSocioTitle">Nuevo socio</h3>
      <form id="formSocio">
        <div class="grid2">
          <div>
            <label>Empresa *</label>
            <input name="empresa" type="text" placeholder="Nombre de la empresa" required />
          </div>
          <div>
            <label>Titular *</label>
            <input name="titular" type="text" placeholder="Nombre del titular" required />
          </div>
          <div>
            <label>Tel√©fono</label>
            <input name="telefono" type="tel" placeholder="300 000 0000" />
          </div>
          <div>
            <label>Direcci√≥n</label>
            <input name="direccion" type="text" placeholder="Calle 123 #45-67" />
          </div>
          <div>
            <label>Logo / Imagen</label>
            <input name="avatar" type="file" accept=".png,.jpg,.jpeg" />
            <div class="muted" style="margin-top:6px">Opcional. M√°x 2 MB.</div>
          </div>
        </div>
        <div class="modal footer">
          <button type="button" class="btn" id="btnCancelSocio">Cancelar</button>
          <button type="submit" class="btn primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function $(s, el){ return (el||document).querySelector(s); }
    function $all(s, el){ return Array.prototype.slice.call((el||document).querySelectorAll(s)); }
    function debug(msg){ var d=$('#debug'); if(d) d.textContent=String(msg); }
    function esc(s){ return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }
    function fmt(n){ return Number(n).toLocaleString('es-CO',{maximumFractionDigits:2}); }

    var SUPABASE_URL      = (window.APP_CONFIG && window.APP_CONFIG.SUPABASE_URL)      || "";
    var SUPABASE_ANON_KEY = (window.APP_CONFIG && window.APP_CONFIG.SUPABASE_ANON_KEY) || "";
    if (!/^https?:\/\//.test(SUPABASE_URL) || !SUPABASE_ANON_KEY) {
      debug('‚ö†Ô∏è Configura SUPABASE_URL / ANON KEY en config.js');
    }

    /* Navegaci√≥n b√°sica y vistas */
    var titleEl = $('#title'), viewEl = $('#view'), navEl = $('#nav'), topActions = $('#topActions');
    var currentCat=null, currentCatName=''; // para subvista de socios
    var prefView = localStorage.getItem('sociosViewMode') || 'cards'; // 'cards' | 'list'

    var VIEWS = {
      pedidos: function(){ return demoCard('Pedidos'); },
      seguimiento: function(){ return demoCard('Seguimiento'); },
      clientes: function(){ return demoCard('Clientes'); },
      inventario: function(){ return demoCard('Inventario'); },
      devoluciones: function(){ return demoCard('Devoluciones'); },
      transacciones: function(){ return demoCard('Transacciones'); },
      socios: function(){ // categor√≠as
        var root = document.createElement('div');
        root.id='sociosRoot';
        root.appendChild(el('div',{id:'socTop',class:'actions-inline',style:{marginBottom:'12px'}}));
        root.appendChild(el('div',{id:'socGrid',class:'grid'}));
        return root;
      }
    };

    function demoCard(t){ var c=document.createElement('div'); c.className='card'; c.innerHTML='<h3>'+t+'</h3><p class="muted">Vista demo.</p>'; return c; }
    function el(tag, attrs, children){
      var node=document.createElement(tag), k; attrs=attrs||{};
      for(k in attrs){
        if(k==='class') node.className=attrs[k];
        else if(k==='style'){ for(var s in attrs[k]) node.style[s]=attrs[k][s]; }
        else node.setAttribute(k, attrs[k]);
      }
      (children||[]).forEach(function(c){
        if(c==null) return;
        if(typeof c==='string') node.appendChild(document.createTextNode(c));
        else node.appendChild(c);
      });
      return node;
    }

    function setActive(tab){
      $all('.nav-btn', navEl).forEach(function(b){ b.classList.toggle('active', b.dataset.view===tab); });
      titleEl.textContent = tab.charAt(0).toUpperCase()+tab.slice(1);
      viewEl.innerHTML = '';
      var viewFactory=VIEWS[tab];
      if(typeof viewFactory==='function') viewEl.appendChild(viewFactory());
      else viewEl.appendChild(demoCard('Sin contenido'));
      location.hash = tab;
      if(tab==='socios') initSociosView();
      else topActions.innerHTML='';
    }

    navEl.addEventListener('click', function(e){
      var btn = e.target.closest('.nav-btn'); if(!btn) return;
      setActive(btn.dataset.view);
    });

    setActive((location.hash||'#socios').slice(1));

    /* Supabase JS */
    var supabaseClient=null;
    (function addSupabase(){
      var s=document.createElement('script');
      s.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js";
      s.onload=function(){
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        if((location.hash||'#socios').slice(1)==='socios') loadCategorias();
      };
      document.head.appendChild(s);
    })();

    /* Utilidades contraste sobre fondo */
    function hexToRgb(hex){ hex=String(hex||'').replace('#',''); if(hex.length===3) hex=hex.split('').map(function(x){return x+x;}).join(''); var num=parseInt(hex,16); if(isNaN(num)) return {r:0,g:0,b:0}; return {r:(num>>16)&255,g:(num>>8)&255,b:num&255};}
    function relLum(c){ function ch(v){v/=255; return v<=0.03928? v/12.92 : Math.pow((v+0.055)/1.055,2.4);} return 0.2126*ch(c.r)+0.7152*ch(c.g)+0.0722*ch(c.b);}
    function contrastColor(bg){ var L=relLum(hexToRgb(bg)); return L>0.5?'#000':'#fff'; }
    function mutedFor(bg){ return contrastColor(bg)==='#000'?'rgba(0,0,0,.72)':'rgba(255,255,255,.72)'; }
    function borderOn(bg){ var L=relLum(hexToRgb(bg)); return L>0.5?'rgba(0,0,0,.25)':'rgba(255,255,255,.25)'; }

    /* ====== CATEGOR√çAS (cards clicables) ====== */
    function initSociosView(){
      topActions.innerHTML = '<button class="btn primary" id="btnNuevaCat">Crear categor√≠a de socios</button>';
      $('#btnNuevaCat').addEventListener('click', openModalCat);
      loadCategorias();
    }

    function openModalCat(){ $('#modalCat').style.display='flex'; }
    $('#btnCancelCat').addEventListener('click', function(){ $('#modalCat').style.display='none'; });

    $('#formCat').addEventListener('submit', async function(e){
      e.preventDefault();
      var f=e.target;
      var nombre=f.nombre.value.trim(), color=f.color.value||'#3ba55d', balance=parseFloat(f.balance.value||'0');
      if(!nombre) return alert('Nombre obligatorio');
      var {error} = await supabaseClient.from('categorias_socios').insert([{nombre,color,balance}]);
      if(error) return alert(error.message);
      $('#modalCat').style.display='none';
      loadCategorias();
    });

    function buildCatCard(row){
      var bg=row.color||'#3ba55d', txt=contrastColor(bg), muted=mutedFor(bg), brd=borderOn(bg);
      var card=el('div',{class:'card',style:{background:bg,borderColor:brd,color:txt}},[]);
      card.setAttribute('data-id',String(row.id||''));
      var top=el('div',{class:'row'},[]), left=el('div',null,[]), actions=el('div',{class:'actions'},[]);
      var title=el('div',{style:{display:'flex',alignItems:'center',gap:'8px',fontWeight:'700'}},[]);
      title.appendChild(el('span',{class:'color-dot',style:{background:bg}}));
      title.appendChild(el('span',null,[String(row.nombre||'‚Äî')]));
      var bal=el('div',{style:{marginTop:'6px',color:muted}},['Balance: $'+fmt(row.balance||0)]);
      left.appendChild(title); left.appendChild(bal);
      var ebtn=el('button',{class:'icon-btn edit',title:'Editar'},[]); ebtn.innerHTML=pencil();
      var dbtn=el('button',{class:'icon-btn delete',title:'Eliminar'},[]); dbtn.innerHTML=trash();
      actions.appendChild(ebtn); actions.appendChild(dbtn);
      top.appendChild(left); top.appendChild(actions); card.appendChild(top);

      card.addEventListener('click', function(ev){
        if(ev.target.closest('.icon-btn')) return; // no abrir si se clicke√≥ acci√≥n
        openSociosList(row.id, row.nombre);
      });

      return card;
    }

    async function loadCategorias(){
      var grid=$('#socGrid'); grid.innerHTML='<div class="loading">Cargando categor√≠as‚Ä¶</div>';
      var {data,error} = await supabaseClient.from('categorias_socios').select('*').order('orden',{ascending:true,nullsFirst:true}).order('created_at',{ascending:false});
      if(error){ grid.innerHTML='<div class="error">'+esc(error.message)+'</div>'; return; }
      grid.innerHTML=''; (data||[]).forEach(function(r){ grid.appendChild(buildCatCard(r)); });
    }

    function pencil(){return '<svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" stroke="currentColor" stroke-width="1.5"/></svg>';}
    function trash(){return '<svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M6 7h12M9 7V4h6v3m-8 3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>';}

    /* ====== SUBVISTA: LISTA DE SOCIOS POR CATEGOR√çA ====== */
    function openSociosList(catId, catName){
      currentCat=catId; currentCatName=catName||'Socios';
      titleEl.textContent = 'Socios ¬∑ '+currentCatName;
      viewEl.innerHTML='';
      // top actions
      var labelBtn = (currentCatName.toLowerCase()==='proveedores' ? 'Crear proveedor' : 'Crear socio');
      topActions.innerHTML = ''
        + '<button class="btn ghost" id="btnBack">‚Üê Volver</button>'
        + '<div class="actions-inline">'
        + ' <button class="btn '+(prefView==='list'?'warn':'')+'" id="btnList">Lista</button>'
        + ' <button class="btn '+(prefView==='cards'?'warn':'')+'" id="btnCards">Tarjetas</button>'
        + ' <button class="btn primary" id="btnNewSocio">'+esc(labelBtn)+'</button>'
        + '</div>';

      $('#btnBack').addEventListener('click', function(){ setActive('socios'); });
      $('#btnList').addEventListener('click', function(){ prefView='list'; localStorage.setItem('sociosViewMode','list'); renderSocios(); this.classList.add('warn'); $('#btnCards').classList.remove('warn'); });
      $('#btnCards').addEventListener('click', function(){ prefView='cards'; localStorage.setItem('sociosViewMode','cards'); renderSocios(); this.classList.add('warn'); $('#btnList').classList.remove('warn'); });
      $('#btnNewSocio').addEventListener('click', function(){ openSocioModal(); });

      viewEl.appendChild(el('div',{id:'socContent'},['Cargando‚Ä¶']));
      renderSocios(); // carga inicial
    }

    async function fetchSocios(){
      var q = supabaseClient.from('socios').select('*').eq('categoria_id', currentCat).order('created_at',{ascending:false});
      var {data,error} = await q;
      if(error){ return {rows:[], error:error}; }
      return {rows:data||[], error:null};
    }

    async function renderSocios(){
      var cont = $('#socContent'); cont.innerHTML='Cargando‚Ä¶';
      var r = await fetchSocios();
      if(r.error){ cont.innerHTML='<div class="error">'+esc(r.error.message)+'</div>'; return; }
      var rows = r.rows;
      if(!rows.length){ cont.innerHTML='<div class="empty">No hay socios en esta categor√≠a.</div>'; return; }

      if(prefView==='list'){ cont.innerHTML=''; cont.appendChild(buildSociosTable(rows)); }
      else { cont.innerHTML=''; cont.appendChild(buildSociosCards(rows)); }
    }

    function initials(txt){
      txt=String(txt||''); var p=txt.trim().split(/\s+/); var ini=p.slice(0,2).map(function(x){return x[0]||'';}).join('').toUpperCase();
      return ini||'SO';
    }

    function buildSociosTable(rows){
      var table = document.createElement('table'); table.className='list';
      var thead=document.createElement('thead'); var trh=document.createElement('tr');
      ['','Empresa','Titular','Tel√©fono','Direcci√≥n',''].forEach(function(h){ var th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
      thead.appendChild(trh); table.appendChild(thead);

      var tbody=document.createElement('tbody');
      rows.forEach(function(r){
        var tr=document.createElement('tr');

        var td0=document.createElement('td');
        var img=r.avatar_url?('<img class="avatar" src="'+esc(r.avatar_url)+'" alt="">') : ('<div class="avatar" style="display:grid;place-items:center;color:var(--muted);font-weight:700">'+initials(r.empresa)+'</div>');
        td0.innerHTML=img; tr.appendChild(td0);

        var td1=document.createElement('td'); td1.innerHTML='<div class="row-flex"><span>'+esc(r.empresa)+'</span></div>'; tr.appendChild(td1);
        var td2=document.createElement('td'); td2.textContent=r.titular||'‚Äî'; tr.appendChild(td2);
        var td3=document.createElement('td'); td3.textContent=r.telefono||'‚Äî'; tr.appendChild(td3);
        var td4=document.createElement('td'); td4.textContent=r.direccion||'‚Äî'; tr.appendChild(td4);

        var td5=document.createElement('td'); td5.innerHTML=''
          + '<div class="mini-actions">'
          + '<button class="icon-btn edit" data-edit="'+r.id+'">'+pencil()+'</button>'
          + '<button class="icon-btn delete" data-del="'+r.id+'">'+trash()+'</button>'
          + '</div>';
        tr.appendChild(td5);

        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      // bind actions
      $all('[data-edit]', table).forEach(function(b){ b.addEventListener('click', function(){ openSocioModal(rows.find(function(x){return String(x.id)===String(b.getAttribute('data-edit'));})); }); });
      $all('[data-del]', table).forEach(function(b){ b.addEventListener('click', function(){ deleteSocio(b.getAttribute('data-del')); }); });

      return table;
    }

    function buildSociosCards(rows){
      var grid = document.createElement('div'); grid.className='grid';
      rows.forEach(function(r){
        var c=document.createElement('div'); c.className='card';
        var header=document.createElement('div'); header.className='row';
        var left=document.createElement('div'); left.className='row-flex';
        var avatar;
        if(r.avatar_url){ avatar=document.createElement('img'); avatar.className='avatar'; avatar.src=r.avatar_url; }
        else { avatar=document.createElement('div'); avatar.className='avatar'; avatar.style.display='grid'; avatar.style.placeItems='center'; avatar.style.color='var(--muted)'; avatar.style.fontWeight='700'; avatar.textContent=initials(r.empresa); }
        left.appendChild(avatar);
        var titleWrap=document.createElement('div');
        var h=document.createElement('div'); h.style.fontWeight='700'; h.textContent=r.empresa||'‚Äî';
        var sub=document.createElement('div'); sub.className='muted'; sub.textContent=r.titular||'‚Äî';
        titleWrap.appendChild(h); titleWrap.appendChild(sub);
        left.appendChild(titleWrap);
        var actions=document.createElement('div'); actions.className='actions';
        var ebtn=document.createElement('button'); ebtn.className='icon-btn edit'; ebtn.innerHTML=pencil(); ebtn.setAttribute('data-edit',r.id);
        var dbtn=document.createElement('button'); dbtn.className='icon-btn delete'; dbtn.innerHTML=trash(); dbtn.setAttribute('data-del',r.id);
        actions.appendChild(ebtn); actions.appendChild(dbtn);
        header.appendChild(left); header.appendChild(actions);
        c.appendChild(header);

        var meta=document.createElement('div'); meta.className='muted'; meta.style.marginTop='8px';
        meta.textContent=(r.telefono||'‚Äî') + (r.direccion?(' ¬∑ '+r.direccion):'');
        c.appendChild(meta);

        grid.appendChild(c);
      });

      // bind actions
      $all('[data-edit]', grid).forEach(function(b){ b.addEventListener('click', function(){ openSocioModal(rows.find(function(x){return String(x.id)===String(b.getAttribute('data-edit'));})); }); });
      $all('[data-del]', grid).forEach(function(b){ b.addEventListener('click', function(){ deleteSocio(b.getAttribute('data-del')); }); });

      return grid;
    }

    /* ====== Modal socio con subida de imagen ====== */
    var socioModal = $('#modalSocio'), socioForm = $('#formSocio'), socioEditId=null;
    $('#btnCancelSocio').addEventListener('click', function(){ socioModal.style.display='none'; socioEditId=null; });

    function openSocioModal(socio){
      socioEditId = socio && socio.id ? socio.id : null;
      $('#modalSocioTitle').textContent = socioEditId ? 'Editar socio' : (currentCatName.toLowerCase()==='proveedores'?'Editar proveedor':'Nuevo socio').replace('Editar','Nuevo');
      socioForm.empresa.value = (socio && socio.empresa) || '';
      socioForm.titular.value = (socio && socio.titular) || '';
      socioForm.telefono.value = (socio && socio.telefono) || '';
      socioForm.direccion.value = (socio && socio.direccion) || '';
      socioForm.avatar.value = '';
      socioModal.style.display='flex';
    }

    socioForm.addEventListener('submit', async function(e){
      e.preventDefault();
      if(!supabaseClient) return alert('Cliente Supabase no disponible');
      var empresa=socioForm.empresa.value.trim();
      var titular=socioForm.titular.value.trim();
      if(!empresa || !titular) return alert('Empresa y Titular son obligatorios');
      var telefono=socioForm.telefono.value.trim();
      var direccion=socioForm.direccion.value.trim();

      let newId = socioEditId;
      if(socioEditId){
        var {error} = await supabaseClient.from('socios').update({empresa,titular,telefono,direccion}).eq('id', socioEditId);
        if(error) return alert(error.message);
      } else {
        var ins = await supabaseClient.from('socios').insert([{categoria_id: currentCat, empresa, titular, telefono, direccion}]).select('id').single();
        if(ins.error) return alert(ins.error.message);
        newId = ins.data.id;
      }

      // subir imagen si adjunta
      var file = socioForm.avatar.files[0];
      if(file){
        if(file.size > 2*1024*1024) return alert('El archivo supera 2 MB');
        var path = newId + '/' + Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9._-]/g,'_');
        var up = await supabaseClient.storage.from('socios').upload(path, file, {upsert:true});
        if(up.error){ alert('Error subiendo imagen: '+up.error.message); }
        else {
          var pub = supabaseClient.storage.from('socios').getPublicUrl(path);
          var url = pub && pub.data && pub.data.publicUrl;
          if(url){ await supabaseClient.from('socios').update({avatar_url:url}).eq('id', newId); }
        }
      }

      socioModal.style.display='none'; socioEditId=null;
      renderSocios();
    });

    async function deleteSocio(id){
      if(!confirm('¬øEliminar este socio?')) return;
      var {error} = await supabaseClient.from('socios').delete().eq('id', id);
      if(error) return alert(error.message);
      renderSocios();
    }
  </script>
</body>
</html>
